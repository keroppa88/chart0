const fs = require('fs');
const path = require('path');

// 設定項目
const API_KEY = process.env.JQUANTS_API_KEY; // GitHubのSecretsから読み込む
const API_URL = "https://api.jquants.com/v2";
////////////////////const DATA_DIR = __dirname; // スクリプトと同じ場所に出力
const DATA_DIR = path.join(__dirname, 'data'); // dataフォルダに出力
const TARGET_STOCKS = ["1306",	"1321",	"1617",	"1618",	"1619",	"1620",	"1621",	"1622",
"1377",	"1379",	"1414",	"1417",	"1419",	"1515",	"1605",	"1662",	"1663",
"1545",	"2243",	"1309",	"4684",	"2559",	"2513",	"2520",	"1332",	"1333",
"1624",	"1625",	"1626",	"1627",	"1628",	"1629",	"1630",	"1631",	"1632",
"1633",	"1343",	"200A",	"1671",	"1540",	"1542",	"1693",	"1546",	"2633",
"1719",	"1720",	"1721",	"1723",	"1762",	"1766",	"1801",	"1802",	"1803",
"1808",	"1812",	"1820",	"1833",	"1835",	"1860",	"1861",	"1871",	"1878",
"1879",	"1885",	"1893",	"1911",	"1925",	"1926",	"1928",	"1929",	"1934",
"1941",	"1942",	"1944",	"1946",	"1950", "1951",	"1952",	"1959",	"1623",
"1961",	"1963",	"1965",	"1968",	"1979",	"1980",	"2001",	"2002",	"2109",
"2121",	"2124",	"2127",	"2146",	"2154",	"2160",	"2168",	"2175",	"2181",
"2201",	"2206",	"2211",	"2212",	"2220",	"2222",	"2229",	"2264",	"2267",
"2269",	"2270",	"2281",	"2282",	"2288",	"2296",	"2317",	"2327",	"2331",
"2337",	"2371",	"2379",	"2384",	"2413",	"2432",	"2433",	"2471",	"2492",
"2501",	"2502",	"2503",	"2531",	"2533",	"2540",	"2579",	"2587",	"2593",
"2602",	"2607",	"2613",	"2659",	"2670",	"2678",	"2681",	"2685",	"2692",
"2695",	"2698",	"2702",	"2726",	"2730",	"2760",	"2767",	"2768",	"2782",
"2784",	"2790",	"2801",	"2802",	"2804",	"2805",	"2809",	"2810",	"2811",
"2815",	"2871",	"2874",	"2875",	"2897",	"2914",	"2936",	"3001",	"3002",
"3003",	"3038",	"3046",	"3048",	"3050",	"3064",	"3076",	"3086",	"3087",
"3088",	"3092",	"3097",	"3099",	"3101",	"3105",	"3106",	"3107",	"3116",
"3132",	"3148",	"3167",	"3186",	"3191",	"3197",	"3201",	"3222",	"3226",
"3231",	"3234",	"3249",	"3269",	"3278",	"3279",	"3282",	"3287",	"3288",
"3289",	"3291",	"3292",	"3295",	"3296",	"3309",	"3349",	"3350",	"3360",
"3382",	"3387",	"3391",	"3395",	"3397",	"3401",	"3402",	"3405",	"3407",
"3433",	"3436",	"3453",	"3462",	"3466",	"3468",	"3471",	"3481",	"3498",
"3543",	"3549",	"3563",	"3569",	"3591",	"3593",	"3612",	"3626",	"3632",
"3635",	"3659",	"3668",	"3697",	"3765",	"3769",	"3774",	"3778",	"3861",
"3863",	"3865",	"3880",	"3923",	"3941",	"3962",	"3993",	"3994",	"4004",
"4005",	"4021",	"4023",	"4028",	"4041",	"4042",	"4043",	"4045",	"4046",
"4061",	"4062",	"4063",	"4064",	"4088",	"4091",	"4095",	"4099",	"4107",
"4109",	"4114",	"4118",	"4151",	"4180",	"4182",	"4183",	"4186",	"4188",
"4194",	"4202",	"4203",	"4204",	"4205",	"4206",	"4208",	"4220",	"4272",
"4307",	"4324",	"4344",	"4368",	"4373",	"4384",	"4385",	"4401",	"4403",
"4443",	"4452",	"4471",	"4477",	"4478",	"4483",	"4502",	"4503",	"4506",
"4507",	"4516",	"4519",	"4521",	"4523",	"4527",	"4528",	"4530",	"4534",
"4536",	"4540",	"4543",	"4544",	"4547",	"4552",	"4553",	"4565",	"4568",
"4578",	"4587",	"4592",	"4612",	"4613",	"4617",	"4626",	"4628",	"4631",
"4633",	"4634",	"4661",	"4665",	"4666",	"4676",	"4680",	"4681",	"4684",
"4686",	"4689",	"4694",	"4704",	"4716",	"4722",	"4732",	"4733",	"4751",
"4755",	"4768",	"4776",	"4784",	"4812",	"4816",	"4819",	"4848",	"4887",
"4901",	"4902",	"4911",	"4912",	"4914",	"4917",	"4922",	"4927",	"4928",
"4931",	"4958",	"4966",	"4967",	"4975",	"4980",	"4985",	"5016",	"5019",
"5020",	"5021",	"5032",	"5076",	"5101",	"5105",	"5108",	"5110",	"5139",
"5161",	"5186",	"5191",	"5192",	"5201",	"5202",	"5214",	"5232",	"5233",
"5273",	"5301",	"5331",	"5332",	"5333",	"5334",	"5344",	"5352",	"5384",
"5393",	"5401",	"5406",	"5411",	"5423",	"5444",	"5449",	"5451",	"5463",
"5471",	"5482",	"5602",	"5631",	"5703",	"5706",	"5711",	"5713",	"5714",
"5715",	"5726",	"5727",	"5741",	"5801",	"5802",	"5803",	"5805",	"5830",
"5831",	"5832",	"5838",	"5844",	"5857",	"5901",	"5911",	"5929",	"5930",
"5938",	"5947",	"5975",	"5991",	"6005",	"6013",	"6027",	"6050",	"6055",
"6080",	"6098",	"6101",	"6103",	"6113",	"6134",	"6135",	"6136",	"6141",
"6143",	"6146",	"6151",	"6178",	"6183",	"6201",	"6250",	"6254",	"6268",
"6269",	"6273",	"6278",	"6301",	"6302",	"6305",	"6315",	"6323",	"6324",
"6326",	"6330",	"6331",	"6332",	"6349",	"6361",	"6366",	"6367",	"6370",
"6371",	"6376",	"6379",	"6383",	"6395",	"6406",	"6407",	"6412",	"6417",
"6420",	"6432",	"6436",	"6440",	"6448",	"6454",	"6455",	"6457",	"6460",
"6465",	"6471",	"6472",	"6473",	"6474",	"6479",	"6480",	"6481",	"6486",
"6490",	"6498",	"6501",	"6503",	"6504",	"6506",	"6507",	"6508",	"6516",
"6523",	"6525",	"6526",	"6532",	"6544",	"6586",	"6588",	"6590",	"6592",
"6594",	"6619",	"6622",	"6632",	"6645",	"6651",	"6670",	"6674",	"6701",
"6702",	"6703",	"6707",	"6723",	"6724",	"6727",	"6728",	"6736",	"6740",
"6744",	"6745",	"6750",	"6752",	"6753",	"6754",	"6758",	"6762",	"6770",
"6787",	"6804",	"6806",	"6807",	"6810",	"6814",	"6841",	"6845",	"6849",
"6856",	"6857",	"6859",	"6861",	"6869",	"6871",	"6875",	"6890",	"6902",
"6920",	"6923",	"6925",	"6941",	"6947",	"6951",	"6952",	"6954",	"6958",
"6960",	"6963",	"6965",	"6966",	"6971",	"6976",	"6981",	"6988",	"6995",
"6996",	"6997",	"7003",	"7004",	"7011",	"7012",	"7013",	"7014",	"7105",
"7148",	"7157",	"7164",	"7167",	"7172",	"7173",	"7180",	"7181",	"7182",
"7184",	"7186",	"7189",	"7201",	"7202",	"7203",	"7205",	"7211",	"7220",
"7222",	"7224",	"7226",	"7231",	"7238",	"7240",	"7242",	"7246",	"7250",
"7259",	"7261",	"7267",	"7269",	"7270",	"7272",	"7276",	"7278",	"7279",
"7282",	"7283",	"7287",	"7296",	"7309",	"7313",	"7322",	"7327",	"7337",
"7350",	"7380",	"7381",	"7389",	"7412",	"7419",	"7421",	"7453",	"7456",
"7458",	"7459",	"7476",	"7483",	"7485",	"7512",	"7516",	"7532",	"7545",
"7550",	"7552",	"7564",	"7581",	"7595",	"7599",	"7611",	"7613",	"7616",
"7630",	"7649",	"7685",	"7701",	"7716",	"7718",	"7729",	"7730",	"7731",
"7733",	"7734",	"7735",	"7739",	"7740",	"7741",	"7744",	"7747",	"7751",
"7752",	"7762",	"7779",	"7780",	"7803",	"7806",	"7817",	"7821",	"7832",
"7846",	"7864",	"7867",	"7868",	"7906",	"7911",	"7912",	"7936",	"7943",
"7947",	"7951",	"7956",	"7965",	"7966",	"7970",	"7972",	"7974",	"7976",
"7981",	"7984",	"7988",	"7994",	"7995",	"8001",	"8002",	"8012",	"8015",
"8020",	"8022",	"8031",	"8032",	"8035",	"8043",	"8050",	"8051",	"8053",
"8056",	"8057",	"8058",	"8060",	"8066",	"8074",	"8078",	"8086",	"8088",
"8097",	"8098",	"8101",	"8111",	"8113",	"8117",	"8129",	"8130",	"8131",
"8133",	"8136",	"8153",	"8154",	"8160",	"8174",	"8179",	"8194",	"8198",
"8214",	"8218",	"8219",	"8227",	"8233",	"8242",	"8244",	"8252",	"8253",
"8267",	"8273",	"8276",	"8278",	"8282",	"8283",	"8303",	"8304",	"8306",
"8308",	"8309",	"8316",	"8331",	"8334",	"8336",	"8337",	"8345",	"8346",
"8354",	"8358",	"8359",	"8360",	"8361",	"8366",	"8367",	"8368",	"8370",
"8377",	"8381",	"8386",	"8388",	"8392",	"8393",	"8410",	"8411",	"8418",
"8421",	"8424",	"8425",	"8439",	"8473",	"8511",	"8515",	"8522",	"8524",
"8544",	"8566",	"8570",	"8572",	"8584",	"8585",	"8591",	"8593",	"8595",
"8600",	"8601",	"8604",	"8609",	"8613",	"8616",	"8628",	"8630",	"8697",
"8698",	"8706",	"8708",	"8714",	"8725",	"8729",	"8739",	"8750",	"8766",
"8795",	"8801",	"8802",	"8803",	"8804",	"8830",	"8848",	"8850",	"8871",
"8876",	"8877",	"8892",	"8919",	"8923",	"8934",	"8951",	"8952",	"8953",
"8954",	"8955",	"8956",	"8957",	"8958",	"8960",	"8961",	"8963",
"8964",	"8966",	"8967",	"8968",	"8975",	"8976",	"8977",	"8984",	"8985",
"8986",	"8987",	"9001",	"9003",	"9005",	"9006",	"9007",	"9008",	"9009",
"9010",	"9020",	"9021",	"9022",	"9023",	"9024",	"9025",	"9031",	"9037",
"9039",	"9041",	"9042",	"9044",	"9045",	"9048",	"9064",	"9065",	"9068",
"9069",	"9072",	"9075",	"9076",	"9090",	"9101",	"9104",	"9107",	"9110",
"9119",	"9142",	"9143",	"9147",	"9166",	"9201",	"9202",	"9204",	"9267",
"9278",	"9301",	"9302",	"9303",	"9336",	"9347",	"9364",	"9401",	"9404",
"9409",	"9412",	"9413",	"9418",	"9432",	"9433",	"9434",	"9435",	"9436",
"9449",	"9468",	"9474",	"9501",	"9502",	"9503",	"9504",	"9505",	"9506",
"9507",	"9508",	"9509",	"9513",	"9519",	"9531",	"9532",	"9533",	"9536",
"9551",	"9552",	"9601",	"9602",	"9603",	"9605",	"9616",	"9627",	"9672",
"9678",	"9682",	"9684",	"9697",	"9699",	"9706",	"9708",	"9715",	"9716",
"9719",	"9722",	"9735",	"9744",	"9746",	"9757",	"9759",	"9766",	"9793",
"9830",	"9831",	"9832",	"9842",	"9843",	"9861",	"9869",	"9882",	"9887",
"9928",	"9934",	"9936",	"9948",	"9956",	"9960",	"9962",	"9974",	"9983",
"9984",	"9987",	"9989",	"141A",	"167A",	"186A",	"215A",	"268A",	"285A",
"290A",	"417A",	"429A"];

// 保存先フォルダがないなら作成
if (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, { recursive: true });


/**
 * 調整後株価（AdjO, AdjH, AdjL, AdjC, AdjVo）を使用してCSVに変換する
 */
function convertToCsv(data) {
    const header = "Date,Open,High,Low,Close,Volume,TradingValue,UpLimit,UnderLimit\n";
    const rows = data.map(d => {
        // 調整後カラム（Adj～）を優先的に取得
        const date = d.Date || "";
        const open = d.AdjO || "0";
        const high = d.AdjH || "0";
        const low = d.AdjL || "0";
        const close = d.AdjC || "0";
        const volume = d.AdjVo || "0";
        const tradingValue = d.Va || "0";
        const upLimit = d.UL || "0";
        const underLimit = d.LL || "0";
        
        return `${date},${open},${high},${low},${close},${volume},${tradingValue},${upLimit},${underLimit}`;
    }).join("\n");
    return header + rows;
}

/**
 * 銘柄ごとのデータを取得してCSV保存する
 */
async function fetchAndSave(code) {
    let allData = [];
    let paginationKey = "";
    
    try {
        do {
            const params = new URLSearchParams({
                code: code,
                from: "2024-07-20",
            });
            if (paginationKey) params.set("pagination_key", paginationKey);
            
            const res = await fetch(`${API_URL}/equities/bars/daily?${params}`, {
                headers: { "x-api-key": API_KEY }
            });
            
            if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
            
            const body = await res.json();
            allData = allData.concat(body.data || []);
            paginationKey = body.pagination_key || "";
        } while (paginationKey);
        
        if (allData.length > 0) {
            const csvContent = convertToCsv(allData);
            fs.writeFileSync(path.join(DATA_DIR, `${code}.csv`), csvContent);
            console.log(`✅成功: ${code}.csv (${allData.length}件)`);
        }
    } catch (e) {
        console.error(`❌エラー ${code}:`, e.message);
    }
}


/**
 * メイン実行処理
 */
async function main() {
    console.log("データ取得を開始します...");
    for (const code of TARGET_STOCKS) {
        await fetchAndSave(code);
        // レートリミット（Lightプラン: 60req/分）を考慮して1秒待機
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
    console.log("すべての処理が完了しました。");
}

main();

