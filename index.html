<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>225銘柄 プロフェッショナル・アナライザー</title>
  <style>
    /* ベースプログラムのUIスタイルを完全踏襲 */
    :root{
      --bg:#f5f5f7; --card:#ffffff; --text:#1f2328; --muted:#6b7280;
      --axisDark:#6b7280; --line:#e5e7eb; --chip:#f3f4f6;
      --shadow: 0 2px 10px rgba(0,0,0,0.06); --baseRed:#cc4a59;
    }
    body{ margin:0; padding:16px; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ width:100%; margin:0 auto; }
    .uiWrap{ max-width:1240px; margin:0 auto; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); padding:16px; margin-bottom:16px; }
    
    .header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .controls{ display:flex; align-items:center; gap:12px; }
    .chip{ background:var(--chip); padding:6px 12px; border-radius:8px; font-size:13px; font-weight:600; color:var(--text); display:flex; align-items:center; gap:8px; }
    
    select, input { border:1px solid var(--line); border-radius:6px; padding:6px 10px; font-size:14px; outline:none; }
    .canvas-stack { display:flex; flex-direction:column; gap:10px; }
    canvas { background:#fff; display:block; cursor:crosshair; touch-action:none; width:100%; border-radius:8px; border:1px solid var(--line); }
    
    #tooltip { position:absolute; pointer-events:none; padding:10px; background:rgba(255,255,255,0.95); border:1px solid var(--line); border-radius:8px; font-size:12px; display:none; z-index:1000; box-shadow:var(--shadow); }
  </style>
</head>
<body>

<div class="wrap uiWrap">
  <div class="card">
    <div class="header">
      <div class="controls">
        <div class="chip">銘柄 
          <select id="stockSelect" onchange="changeStock()"></select>
        </div>
        <div class="chip" id="viewChip">表示: <span id="vCountText">100</span>本</div>
      </div>
      <div class="controls">
        <div class="chip" id="statusChip">読込中...</div>
      </div>
    </div>

    <div class="canvas-stack">
      <div style="position:relative;">
        <div id="tooltip"></div>
        <canvas id="mainChart" height="450"></canvas>
      </div>
      <canvas id="macdChart" height="120"></canvas>
      <canvas id="stochChart" height="120"></canvas>
      <canvas id="rsiChart" height="120"></canvas>
    </div>
  </div>
</div>

<script>
/** 状態管理 **/
let allStocks = {}; 
let currentCode = "";
let ohlcv = []; 
let indicators = {};
let displayCount = 100;
let startIndex = 0;
let isDragging = false;
let lastMouseX = 0;

const canvases = {
  main:  { el: document.getElementById('mainChart'), ctx: document.getElementById('mainChart').getContext('2d') },
  macd:  { el: document.getElementById('macdChart'), ctx: document.getElementById('macdChart').getContext('2d') },
  stoch: { el: document.getElementById('stochChart'), ctx: document.getElementById('stochChart').getContext('2d') },
  rsi:   { el: document.getElementById('rsiChart'), ctx: document.getElementById('rsiChart').getContext('2d') }
};

/** 1. combined_long.csv からの全銘柄自動読込 **/
async function loadSystem() {
  try {
    const res = await fetch('combined_long.csv');
    if (!res.ok) throw new Error("combined_long.csv Not Found");
    const text = await res.text();
    const rows = text.trim().split('\n').slice(1);

    const temp = {};
    rows.forEach(row => {
      const [date, weekday, name, val] = row.split(',');
      if (!date || !name) return;
      const code = name.slice(0, 4);
      const type = name.slice(4);
      const v = parseFloat(val);

      if (!temp[code]) temp[code] = {};
      if (!temp[code][date]) temp[code][date] = { time: date };
      
      if      (type === "始値")   temp[code][date].o = v;
      else if (type === "高値")   temp[code][date].h = v;
      else if (type === "安値")   temp[code][date].l = v;
      else if (type === "終値")   temp[code][date].c = v;
      else if (type === "出来高") temp[code][date].v = v;
    });

    const select = document.getElementById('stockSelect');
    const codes = Object.keys(temp).sort();
    codes.forEach(code => {
      const opt = document.createElement('option');
      opt.value = code; opt.textContent = code;
      select.appendChild(opt);
      allStocks[code] = Object.values(temp[code]).sort((a,b) => a.time.localeCompare(b.time));
    });

    document.getElementById('statusChip').textContent = `${codes.length} 銘柄`;
    currentCode = codes[0];
    initStock(currentCode);

  } catch (err) {
    document.getElementById('statusChip').textContent = "Error";
    console.error(err);
  }
}

/** 2. インジケータ計算 (MA, MACD, Stoch, RSI) **/
function computeIndicators() {
  const c = ohlcv.map(d => d.c), h = ohlcv.map(d => d.h), l = ohlcv.map(d => d.l);
  const sma = (d, p) => d.map((_, i) => i < p-1 ? null : d.slice(i-p+1, i+1).reduce((a,b)=>a+b,0)/p);
  
  // RSI
  const rsi = (d, p) => {
    let r = new Array(d.length).fill(null), u = 0, dn = 0;
    for(let i=1; i<d.length; i++){
      const diff = d[i]-d[i-1]; u += Math.max(0, diff); dn += Math.max(0, -diff);
      if(i >= p){ if(i>p){ u -= Math.max(0, d[i-p]-d[i-p-1]); dn -= Math.max(0, -(d[i-p]-d[i-p-1])); }
      r[i] = (u/(u+dn))*100; }
    } return r;
  };

  // MACD
  const ema = (d, p) => { const k=2/(p+1); let r=[d[0]]; for(let i=1; i<d.length; i++) r.push(d[i]*k + r[i-1]*(1-k)); return r; };
  const fast = ema(c, 12), slow = ema(c, 26), diff = fast.map((v,i)=>v-slow[i]), sig = ema(diff, 9);

  // Stoch
  const stoch = (h,l,c,pk,pd,ps) => {
    const kr = c.map((v,i) => { if(i<pk) return null; const hh=Math.max(...h.slice(i-pk+1,i+1)), ll=Math.min(...l.slice(i-pk+1,i+1)); return ((v-ll)/(hh-ll))*100; });
    const k = sma(kr.filter(v=>v!==null), pd), d = sma(k.filter(v=>v!==null), ps);
    return { k: new Array(pk+pd-2).fill(null).concat(k), d: new Array(pk+pd+ps-3).fill(null).concat(d) };
  };

  indicators = { ma5: sma(c,5), ma25: sma(c,25), rsi: rsi(c,14), macd: {diff, sig}, stoch: stoch(h,l,c,14,3,3) };
}

/** 3. 描画ロジック (UI完全踏襲版) **/
function draw() {
  if (!ohlcv.length) return;
  const visible = ohlcv.slice(startIndex, startIndex + displayCount);
