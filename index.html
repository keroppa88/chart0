<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>爆速225チャート</title>
  <style>
    body { margin: 0; padding: 1rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f5; color: #333; }
    .container { max-width: 1400px; margin: 0 auto; background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
    .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
    select, input { padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc; }
    canvas { display: block; background: #fff; cursor: crosshair; touch-action: none; }
    .chart-area { position: relative; border: 1px solid #eee; margin-bottom: 10px; }
    #tooltip { position: absolute; pointer-events: none; padding: 8px; background: rgba(255,255,255,0.95); border: 1px solid #ccc; font-size: 12px; display: none; z-index: 100; box-shadow: 2px 2px 6px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<div class="container">
  <div class="title-row">
    <div class="controls">
      <strong>銘柄:</strong>
      <select id="stockSelect" onchange="changeStock()"></select>
      <span>表示本数:</span>
      <input type="number" id="viewCount" value="100" min="20" max="500" style="width:60px;" onchange="updateViewCount()">
    </div>
    <div id="infoDisplay" style="font-size: 14px; font-weight: bold; color: #555;"></div>
  </div>

  <div class="chart-area">
    <div id="tooltip"></div>
    <canvas id="mainChart"></canvas>
  </div>
</div>

<script>
/**
 * 設定とグローバル変数
 */
let allStocksData = {}; // 全銘柄のデータを格納
let currentCode = "";
let dates = [];
let ohlcv = []; // {open, high, low, close, volume}
let viewCount = 100;
let startIndex = 0;

const mainCanvas = document.getElementById('mainChart');
const mainCtx = mainCanvas.getContext('2d');
const tooltip = document.getElementById('tooltip');

/**
 * 1. CSVデータの読み込みとパース (combined_long.csv専用)
 */
async function loadData() {
  const el = document.getElementById('infoDisplay');
  el.textContent = "データ読み込み中...";

  try {
    const res = await fetch('combined_long.csv');
    if (!res.ok) throw new Error("combined_long.csvが見つかりません");
    const text = await res.text();
    const rows = text.trim().split('\n').slice(1);

    const tempStore = {};

    rows.forEach(row => {
      const [date, weekday, name, val] = row.split(',');
      if (!date || !name) return;

      const code = name.slice(0, 4);
      const type = name.slice(4);
      const value = parseFloat(val);

      if (!tempStore[code]) tempStore[code] = {};
      if (!tempStore[code][date]) tempStore[code][date] = { date: date };

      if (type === "始値") tempStore[code][date].open = value;
      else if (type === "高値") tempStore[code][date].high = value;
      else if (type === "安値") tempStore[code][date].low = value;
      else if (type === "終値") tempStore[code][date].close = value;
      else if (type === "出来高") tempStore[code][date].volume = value;
    });

    // 銘柄リストをプルダウンに反映
    const select = document.getElementById('stockSelect');
    const codes = Object.keys(tempStore).sort();
    codes.forEach(code => {
      const opt = document.createElement('option');
      opt.value = code;
      opt.textContent = code;
      select.appendChild(opt);
      
      // データを配列形式に変換して保存
      const sortedDates = Object.values(tempStore[code]).sort((a,b) => a.date.localeCompare(b.date));
      allStocksData[code] = sortedDates;
    });

    currentCode = codes[0];
    el.textContent = `全 ${codes.length} 銘柄 読込完了`;
    initChart(currentCode);

  } catch (err) {
    el.textContent = `エラー: ${err.message}`;
  }
}

/**
 * 2. チャートの初期化と描画
 */
function initChart(code) {
  const data = allStocksData[code];
  dates = data.map(d => d.date);
  ohlcv = data.map(d => ({
    o: d.open, h: d.high, l: d.low, c: d.close, v: d.volume || 0
  }));
  
  startIndex = Math.max(0, ohlcv.length - viewCount);
  resizeCanvas();
}

function resizeCanvas() {
  const container = mainCanvas.parentElement;
  mainCanvas.width = container.clientWidth;
  mainCanvas.height = 500;
  draw();
}

function draw() {
  if (ohlcv.length === 0) return;

  const ctx = mainCtx;
  const w = mainCanvas.width;
  const h = mainCanvas.height;
  const chartW = w - 60; // 右側に価格ラベル用余白
  const chartH = h - 30; // 下側に日付ラベル用余白

  ctx.clearRect(0, 0, w, h);

  // 表示範囲のデータ
  const visible = ohlcv.slice(startIndex, startIndex + viewCount);
  const maxPrice = Math.max(...visible.map(d => d.h)) * 1.02;
  const minPrice = Math.min(...visible.map(d => d.l)) * 0.98;
  const maxVol = Math.max(...visible.map(d => d.v));

  const getX = (i) => (i / viewCount) * chartW + (chartW / viewCount / 2);
  const getY = (p) => chartH - ((p - minPrice) / (maxPrice - minPrice)) * chartH;

  // 出来高の描画（背景的に薄く表示）
  visible.forEach((d, i) => {
    const x = (i / viewCount) * chartW;
    const barW = (chartW / viewCount) * 0.8;
    const barH = (d.v / maxVol) * (chartH * 0.2); // 高さの20%を使用
    ctx.fillStyle = d.c >= d.o ? 'rgba(239, 83, 80, 0.2)' : 'rgba(38, 166, 154, 0.2)';
    ctx.fillRect(x + (chartW/viewCount*0.1), chartH - barH, barW, barH);
  });

  // グリッド線とラベル
  ctx.strokeStyle = "#eee";
  ctx.beginPath();
  for(let j=0; j<=5; j++) {
    const p = minPrice + (maxPrice - minPrice) * (j/5);
    const y = getY(p);
    ctx.moveTo(0, y); ctx.lineTo(chartW, y);
    ctx.fillStyle = "#999"; ctx.fillText(p.toFixed(0), chartW + 5, y + 4);
  }
  ctx.stroke();

  // ローソク足の描画
  visible.forEach((d, i) => {
    const x = getX(i);
    const bw = (chartW / viewCount) * 0.7;
    
    ctx.strokeStyle = d.c >= d.o ? "#ef5350" : "#26a69a";
    ctx.fillStyle = ctx.strokeStyle;

    // ヒゲ
    ctx.beginPath();
    ctx.moveTo(x, getY(d.h)); ctx.lineTo(x, getY(d.l));
    ctx.stroke();

    // 実体
    const yOpen = getY(d.o);
    const yClose = getY(d.c);
    ctx.fillRect(x - bw/2, Math.min(yOpen, yClose), bw, Math.max(1, Math.abs(yOpen - yClose)));
  });

  // 軸の日付表示
  ctx.fillStyle = "#666";
  ctx.fillText(dates[startIndex], 5, h - 5);
  ctx.fillText(dates[startIndex + visible.length - 1], chartW - 70, h - 5);
}

/**
 * 3. ユーティリティ
 */
function changeStock() {
  currentCode = document.getElementById('stockSelect').value;
  initChart(currentCode);
}

function updateViewCount() {
  viewCount = parseInt(document.getElementById('viewCount').value);
  startIndex = Math.max(0, ohlcv.length - viewCount);
  draw();
}

// 初期化
window.addEventListener('resize', resizeCanvas);
loadData();

</script>
</body>
</html>

