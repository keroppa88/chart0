<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>株価チャート（自動読込・ロング形式・ホイール可変・ドラッグ移動）</title>
  <style>
    body { margin: 0; padding: 1rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f5f5; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    .title-row{ display:flex; align-items:baseline; gap:10px; }
    h1 { margin: 0; font-size: 1.5rem; color: #333; }
    .help-btn{ font-size:12px; padding:3px 8px; background:#e0e0e0; color:#000; border:1px solid #bdbdbd; border-radius:4px; cursor:pointer; }
    .help-btn:hover{ background:#d5d5d5; }

    .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal{ width:min(720px, calc(100vw - 40px)); background:#fff; border:1px solid #ccc; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.25); padding:14px 16px; }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .modal-title{ font-size:14px; font-weight:700; margin:0; }
    .modal-close{ font-size:12px; padding:3px 8px; background:#e0e0e0; color:#000; border:1px solid #bdbdbd; border-radius:4px; cursor:pointer; }
    .modal-close:hover{ background:#d5d5d5; }
    .modal-body{ font-size:13px; color:#333; line-height:1.7; white-space:pre-line; }

    .controls-row { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; align-items:center; padding-bottom:10px; border-bottom:1px solid #eee; }
    .param-group { display:flex; align-items:center; gap:6px; font-size:13px; background:#f9f9f9; padding:4px 8px; border-radius:4px; border:1px solid #eee; }
    .param-group label { font-weight:600; color:#555; }
    .param-group input { width:45px; padding:2px 4px; border:1px solid #ccc; border-radius:3px; text-align:center; }
    .param-group select{ padding:2px 6px; border:1px solid #ccc; border-radius:3px; background:#fff; }

    .hint { font-size:12px; color:#666; }
    .legend { display:flex; gap:15px; font-size:12px; margin-bottom:10px; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:4px; }
    .legend-color { width:12px; height:12px; border-radius:2px; }

    canvas { display:block; width:100%; cursor:crosshair; }
    #mainChart { height:350px; border:1px solid #ddd; border-bottom:none; }

    .indicator-container { border:1px solid #ddd; border-top:none; background:#fff; position:relative; }
    .indicator-controls { position:absolute; top:2px; right:2px; pointer-events:auto; display:flex; gap:2px; z-index:10; }
    .btn-icon { width:16px; height:16px; border:none; color:#fff; font-size:10px; line-height:1; cursor:pointer; display:flex; align-items:center; justify-content:center; border-radius:2px; opacity:0.7; }
    .btn-icon:hover { opacity:1; }
    .btn-move { background:#2196f3; }
    .btn-toggle { background:#666; }
    .indicator-wrapper { height:120px; transition:height 0.2s; overflow:hidden; }
    .indicator-wrapper.collapsed { height:0; }
    .indicator-canvas { height:100%; width:100%; }

    .tooltip { position:absolute; background:rgba(255,255,255,0.95); border:1px solid #999; padding:8px; border-radius:4px; font-size:12px; pointer-events:none; display:none; box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:100; line-height:1.4; white-space:nowrap; }
  </style>
</head>
<body>

<div class="container">
  <div class="title-row">
    <h1>株価チャート</h1>
    <button id="helpBtn" class="help-btn" type="button">使い方</button>
  </div>

  <div class="controls-row" style="margin-top:15px;">
    <div class="param-group">
      <label>銘柄</label>
      <select id="symbolSelect"></select>
    </div>

    <div class="param-group">
      <label>クイック</label>
      <select id="quickSelect">
        <option value="">-</option>
        <option value="20">20</option>
        <option value="100" selected>100</option>
        <option value="200">200</option>
        <option value="500">500</option>
      </select>
    </div>

    <span id="autoStatus" class="hint">combined_long.csv を自動読込します</span>
    <span id="status" class="hint" style="margin-left:auto;"></span>
  </div>

  <div class="controls-row">
    <span class="hint" id="viewInfo">表示本数: - / 表示範囲: -</span>
    <span class="hint" style="margin-left:auto;">ホイール: 前=縮める(−1) / 後=広げる(+1) ・ ドラッグ: 左右に移動</span>
  </div>

  <div class="controls-row">
    <div class="param-group"><label>MA1</label><input type="number" id="ma1Period" value="20"></div>
    <div class="param-group"><label>MA2</label><input type="number" id="ma2Period" value="60"></div>
    <div class="param-group"><label>RSI</label><input type="number" id="rsiPeriod" value="14"></div>
    <div class="param-group"><label>Stoch K</label><input type="number" id="stochK" value="14"></div>
    <div class="param-group"><label>Stoch D</label><input type="number" id="stochD" value="3"></div>
    <div class="param-group"><label>MACD S</label><input type="number" id="macdShort" value="12"></div>
    <div class="param-group"><label>MACD L</label><input type="number" id="macdLong" value="26"></div>
    <div class="param-group"><label>Sig</label><input type="number" id="macdSignal" value="9"></div>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-color" style="background:#333"></div><span id="priceLegend">価格</span></div>
    <div class="legend-item"><div class="legend-color" style="background:#ff9800"></div>MA1</div>
    <div class="legend-item"><div class="legend-color" style="background:#2196f3"></div>MA2</div>
    <div class="legend-item"><div class="legend-color" style="background:#9c27b0"></div>RSI</div>
    <div class="legend-item"><div class="legend-color" style="background:#00bcd4"></div>%K</div>
    <div class="legend-item"><div class="legend-color" style="background:#ff5722"></div>%D</div>
  </div>

  <canvas id="mainChart"></canvas>

  <div id="indicatorsList">
    <div class="indicator-container" id="macdContainer">
      <div class="indicator-controls">
        <button class="btn-icon btn-move" onclick="moveIndicator('macd','up')">▲</button>
        <button class="btn-icon btn-move" onclick="moveIndicator('macd','down')">▼</button>
        <button class="btn-icon btn-toggle" onclick="toggleIndicator('macd')">−</button>
      </div>
      <div class="indicator-wrapper" id="macdWrapper">
        <canvas class="indicator-canvas" id="macdChart"></canvas>
      </div>
    </div>
    <div class="indicator-container" id="stochContainer">
      <div class="indicator-controls">
        <button class="btn-icon btn-move" onclick="moveIndicator('stoch','up')">▲</button>
        <button class="btn-icon btn-move" onclick="moveIndicator('stoch','down')">▼</button>
        <button class="btn-icon btn-toggle" onclick="toggleIndicator('stoch')">−</button>
      </div>
      <div class="indicator-wrapper" id="stochWrapper">
        <canvas class="indicator-canvas" id="stochChart"></canvas>
      </div>
    </div>
    <div class="indicator-container" id="rsiContainer">
      <div class="indicator-controls">
        <button class="btn-icon btn-move" onclick="moveIndicator('rsi','up')">▲</button>
        <button class="btn-icon btn-move" onclick="moveIndicator('rsi','down')">▼</button>
        <button class="btn-icon btn-toggle" onclick="toggleIndicator('rsi')">−</button>
      </div>
      <div class="indicator-wrapper" id="rsiWrapper">
        <canvas class="indicator-canvas" id="rsiChart"></canvas>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>
</div>

<div id="helpModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <p class="modal-title">使い方</p>
      <button id="helpCloseBtn" class="modal-close">閉じる</button>
    </div>
    <div class="modal-body">
- combined_long.csv を読み込みます。UTF-8形式を推奨。
- chartlist.csv があれば銘柄を限定します。
- ホイール: ズーム / ドラッグ: 移動
    </div>
  </div>
</div>

<script>
let longRows = [];
let chartListItems = null;
let series = [];
let displayCount = 100;
let offsetX = 0;
let isDragging = false;
let dragStartX = 0;
let dragStartOffset = 0;

let params = { ma1: 20, ma2: 60, rsi: 14, stochK: 14, stochD: 3, macdShort: 12, macdLong: 26, macdSignal: 9 };
let mainCanvas, mainCtx, macdCanvas, macdCtx, stochCanvas, stochCtx, rsiCanvas, rsiCtx, tooltip;
let collapsed = { macd: false, stoch: false, rsi: false };
let indicators = { ma1: [], ma2: [], rsi: [], stoch: { k: [], d: [] }, macd: { macd: [], signal: [], hist: [] } };
let backBuffers = { main: null, macd: null, stoch: null, rsi: null };

function toNum(s){ return Number(String(s||"").replace(/,/g,'').replace(/"/g,'').trim()); }
function parseDelimitedLine(line, delim){
  const out=[]; let cur=""; let inQ=false;
  for(const ch of line){
    if(ch==='"'){ inQ=!inQ; continue; }
    if(ch===delim && !inQ){ out.push(cur); cur=""; }
    else cur+=ch;
  }
  out.push(cur); return out;
}
function detectDelimiter(headerLine){
  return (headerLine.match(/\t/g)||[]).length >= (headerLine.match(/,/g)||[]).length ? "\t" : ",";
}
function parseLongFormat(text){
  const lines=text.trim().split(/\r?\n/);
  const delim=detectDelimiter(lines[0]);
  const header=parseDelimitedLine(lines[0],delim).map(s=>s.trim());
  const iD=header.indexOf("日付"), iN=header.indexOf("商品名"), iV=header.indexOf("数値");
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cols=parseDelimitedLine(lines[i],delim);
    if(cols.length<3) continue;
    rows.push({date:cols[iD].trim(), name:cols[iN].trim(), value:toNum(cols[iV])});
  }
  return rows;
}
function parseChartList(text){
  const lines=text.trim().split(/\r?\n/).filter(s=>s&&!s.startsWith('#'));
  const delim=detectDelimiter(lines[0]||"");
  return lines.map(l=>{
    const c=parseDelimitedLine(l, delim).map(s=>s.trim());
    return {value:c[0], label:c[1]||c[0]};
  });
}

const OHLC_FIELDS = ["始値","高値","安値","終値"];
const OHLC_RE = /(始値|高値|安値|終値)$/;
let chartMode = "line";
let symbolMeta = null;

function splitOhlcName(name){
  const m = String(name||"").match(OHLC_RE);
  return m ? { base: name.slice(0, -m[1].length), field: m[1] } : { base: name, field: null };
}
function buildSymbolMeta(rows){
  const allNames = new Set(); const b2f = new Map();
  rows.forEach(r=>{
    allNames.add(r.name); const sp=splitOhlcName(r.name);
    if(sp.field){ if(!b2f.has(sp.base)) b2f.set(sp.base, new Set()); b2f.get(sp.base).add(sp.field); }
  });
  const cbs = new Set(); b2f.forEach((f,b)=>{ if(OHLC_FIELDS.every(x=>f.has(x))) cbs.add(b); });
  return { allNames, candleBaseSet: cbs };
}

function populateSymbolSelect(){
  const sel = document.getElementById('symbolSelect');
  const current = sel.value;
  if(!symbolMeta) symbolMeta = buildSymbolMeta(longRows);
  sel.innerHTML = "";
  if(chartListItems){
    chartListItems.forEach(item=>{
      const opt = document.createElement('option');
      opt.value = item.value; opt.textContent = item.value + (item.label!==item.value ? ","+item.label : "");
      sel.appendChild(opt);
    });
  } else {
    symbolMeta.candleBaseSet.forEach(b=>{ const o=document.createElement('option'); o.value=o.textContent=b; sel.appendChild(o); });
    symbolMeta.allNames.forEach(n=>{ if(!splitOhlcName(n).field){ const o=document.createElement('option'); o.value=o.textContent=n; sel.appendChild(o); }});
  }
  if(current) sel.value = current;
}

function buildLineSeries(rows, target){
  const map=new Map(); rows.forEach(r=>{ if(r.name===target) map.set(r.date, r.value); });
  return Array.from(map.keys()).sort().map(d=>({date:d, open:map.get(d), high:map.get(d), low:map.get(d), close:map.get(d)}));
}
function buildOhlcSeries(rows, base){
  const byD = new Map();
  rows.forEach(r=>{
    const sp=splitOhlcName(r.name); if(sp.base!==base||!sp.field) return;
    if(!byD.has(r.date)) byD.set(r.date, {date:r.date, open:null, high:null, low:null, close:null});
    const o=byD.get(r.date);
    if(sp.field==="始値") o.open=r.value; if(sp.field==="高値") o.high=r.value; if(sp.field==="安値") o.low=r.value; if(sp.field==="終値") o.close=r.value;
  });
  return Array.from(byD.keys()).sort().map(d=>byD.get(d));
}

function calculateMA(data, p){
  const r=new Array(data.length).fill(null);
  for(let i=p-1; i<data.length; i++){ let s=0; for(let j=0;j<p;j++) s+=data[i-j].close; r[i]=s/p; }
  return r;
}
function calculateRSI(data, p){
  const r=new Array(data.length).fill(null); if(data.length<=p) return r;
  let g=0, l=0; for(let i=1;i<=p;i++){ const d=data[i].close-data[i-1].close; if(d>0) g+=d; else l-=d; }
  let ag=g/p, al=l/p; r[p]=al===0?100:(100-(100/(1+ag/al)));
  for(let i=p+1;i<data.length;i++){
    const d=data[i].close-data[i-1].close; const gn=d>0?d:0, ls=d<0?-d:0;
    ag=(ag*(p-1)+gn)/p; al=(al*(p-1)+ls)/p; r[i]=al===0?100:(100-(100/(1+ag/al)));
  }
  return r;
}
function calculateMACD(data, sP, lP, sigP){
  const m=new Array(data.length).fill(null), s=new Array(data.length).fill(null), h=new Array(data.length).fill(null);
  let eS=data[0].close, eL=data[0].close;
  for(let i=0;i<data.length;i++){
    eS+=(data[i].close-eS)*(2/(sP+1)); eL+=(data[i].close-eL)*(2/(lP+1));
    if(i>=lP-1) m[i]=eS-eL;
  }
  let eSig=m[lP-1];
  for(let i=lP-1;i<data.length;i++){
    if(i===lP-1) s[i]=m[i]; else { eSig+=(m[i]-eSig)*(2/(sigP+1)); s[i]=eSig; }
    h[i]=m[i]-s[i];
  }
  return {macd:m, signal:s, hist:h};
}
function calculateStoch(data, kP, dP){
  const k=new Array(data.length).fill(null), d=new Array(data.length).fill(null);
  for(let i=kP-1;i<data.length;i++){
    let hi=-Infinity, lo=Infinity; for(let j=0;j<kP;j++){ hi=Math.max(hi,data[i-j].high); lo=Math.min(lo,data[i-j].low); }
    k[i]=hi===lo?50:((data[i].close-lo)/(hi-lo))*100;
  }
  for(let i=kP+dP-2;i<data.length;i++){ let s=0; for(let j=0;j<dP;j++) s+=k[i-j]; d[i]=s/dP; }
  return {k, d};
}

function recomputeIndicators(){
  if(!series.length) return;
  indicators.ma1=calculateMA(series,params.ma1); indicators.ma2=calculateMA(series,params.ma2);
  indicators.rsi=calculateRSI(series,params.rsi); indicators.macd=calculateMACD(series,params.macdShort,params.macdLong,params.macdSignal);
  indicators.stoch=calculateStoch(series,params.stochK,params.stochD);
}

function getVisibleWindow(){
  displayCount=Math.max(10, Math.min(displayCount, series.length||100));
  offsetX=Math.max(0, Math.min(offsetX, (series.length||0)-displayCount));
  const start=Math.max(0, series.length-displayCount-Math.round(offsetX));
  const end=Math.min(series.length, start+displayCount);
  const slice=series.slice(start, end); const padN=displayCount-slice.length;
  const pads=new Array(padN).fill(null).map(()=>({date:"", open:null, high:null, low:null, close:null}));
  return { visibleCandles: pads.concat(slice), visibleIndices: new Array(padN).fill(null).concat(Array.from({length:slice.length},(_,i)=>start+i)) };
}

function updateViewInfo(){
  const el=document.getElementById('viewInfo'); if(!series.length){ el.textContent="表示本数: -"; return; }
  const {visibleCandles: vC}=getVisibleWindow(); let sd="", ed="";
  for(let c of vC){ if(c.date){ sd=c.date; break; } } for(let i=vC.length-1;i>=0;i--){ if(vC[i].date){ ed=vC[i].date; break; } }
  el.textContent=`表示本数: ${displayCount} / 表示範囲: ${sd} ~ ${ed}`;
}

async function autoLoadFiles(){
  try {
    const rL=await fetch('./combined_long.csv',{cache:'no-store'}); if(!rL.ok) throw new Error();
    longRows=parseLongFormat(await rL.text()); symbolMeta=buildSymbolMeta(longRows);
    const rC=await fetch('./chartlist.csv',{cache:'no-store'}); if(rC.ok) chartListItems=parseChartList(await rC.text());
    populateSymbolSelect(); applySymbol();
  } catch(e){ document.getElementById('autoStatus').textContent="読込エラー"; }
}

function applySymbol(){
  const sel=document.getElementById('symbolSelect'); if(!sel.value) return;
  if(symbolMeta.candleBaseSet.has(sel.value)){ chartMode="candle"; series=buildOhlcSeries(longRows, sel.value); }
  else
